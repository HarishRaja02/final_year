{% extends "base.html" %}
{% block content %}
<section class="panel rounded-3xl p-6 fade-up">
    <div class="flex items-center justify-between gap-4">
        <div>
            <h1 class="brand-title text-2xl text-slate-900">Case Outcome Predictor</h1>
            <p class="text-sm text-slate-500 mt-1">Index case files and receive structured outcome analysis.</p>
        </div>
        <div id="global-loader" class="hidden"><div class="loader"></div></div>
    </div>

    <label class="text-sm font-semibold text-slate-700 mt-6 block">Step 1: Upload case PDF</label>
    <div class="mt-3 flex flex-col md:flex-row md:items-center gap-4">
        <input type="file" id="case-file" class="block w-full text-sm text-slate-500" accept="application/pdf">
        <button id="index-btn" onclick="Handlers.handleCaseIndexing()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">Index PDF</button>
    </div>

    <div class="mt-6 border-t border-slate-200 pt-6">
        <label class="text-sm font-semibold text-slate-700">Step 2: Ask your question</label>
        <textarea id="case-query" class="input w-full mt-3 p-4 rounded-xl h-32" placeholder="Example: likelihood of injunction based on prior decisions and evidence."></textarea>
        <button id="predict-btn" onclick="Handlers.handleCasePrediction()" class="btn-accent text-white mt-4 px-6 py-3 rounded-xl font-semibold">Predict Outcome</button>
    </div>
</section>

<section id="predict-result" class="panel rounded-3xl p-6 prose max-w-none fade-up stagger-1 mt-6"></section>
{% endblock %}

{% block scripts %}
<script>
    const Handlers = {
        async handleCaseIndexing() {
            const file = document.getElementById("case-file").files[0];
            if (!file || file.type !== "application/pdf") return UI.notify("Upload a valid PDF", "error");

            const formData = new FormData();
            formData.append("file", file);

            UI.setLoading("index-btn", true);
            try {
                await ApiService.post("/api/index_case", formData, true);
                UI.notify("Case documents indexed successfully", "success");
            } finally {
                UI.setLoading("index-btn", false);
            }
        },

        async handleCasePrediction() {
            const query = document.getElementById("case-query").value.trim();
            if (!query) return UI.notify("Describe the scenario", "error");

            UI.setLoading("predict-btn", true);
            try {
                const data = await ApiService.post("/api/predict", { query });
                UI.renderResult("predict-result", data.prediction);
            } finally {
                UI.setLoading("predict-btn", false);
            }
        }
    };
</script>
{% endblock %}

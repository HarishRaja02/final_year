{% extends "base.html" %}
{% block content %}
<section class="panel rounded-3xl p-6 fade-up">
    <div class="flex items-center justify-between gap-4">
        <div>
            <h1 class="brand-title text-2xl text-slate-900">Legal Document Locker</h1>
            <p class="text-sm text-slate-500 mt-1">Securely store, download, and manage your documents.</p>
        </div>
        <div id="global-loader" class="hidden"><div class="loader"></div></div>
    </div>
    <label class="text-sm font-semibold text-slate-700 mt-6 block">Upload a legal document</label>
    <div class="mt-3 flex flex-col md:flex-row md:items-center gap-4">
        <input type="file" id="doc-file" class="block w-full text-sm text-slate-500">
        <button id="doc-upload-btn" onclick="Handlers.handleDocumentUpload()" class="btn-primary text-white px-5 py-2 rounded-lg text-sm">Upload</button>
    </div>
    <p class="text-xs text-slate-500 mt-2">Stored locally on this server. You can upgrade to cloud storage later.</p>
</section>

<section class="panel rounded-3xl p-6 fade-up stagger-1 mt-6">
    <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-slate-800">Your Documents</h3>
        <button onclick="Handlers.refreshDocuments()" class="text-xs text-slate-500 hover:text-slate-900">Refresh</button>
    </div>
    <div id="doc-list" class="mt-4 space-y-3 text-sm text-slate-600"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
    const Handlers = {
        async handleDocumentUpload() {
            const file = document.getElementById("doc-file").files[0];
            if (!file) return UI.notify("Please select a document", "error");

            const formData = new FormData();
            formData.append("file", file);

            UI.setLoading("doc-upload-btn", true);
            try {
                await ApiService.post("/api/documents/upload", formData, true);
                UI.notify("Document uploaded", "success");
                await Handlers.refreshDocuments();
            } finally {
                UI.setLoading("doc-upload-btn", false);
            }
        },

        async refreshDocuments() {
            const list = document.getElementById("doc-list");
            list.innerHTML = "Loading documents...";
            const data = await ApiService.get("/api/documents");
            if (!data.documents.length) {
                list.innerHTML = "No documents uploaded yet.";
                return;
            }
            list.innerHTML = data.documents.map(doc => {
                const sizeKb = Math.ceil(doc.size_bytes / 1024);
                return `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 border border-slate-200 rounded-xl p-3">
                        <div>
                            <div class="font-semibold text-slate-800">${doc.original_name}</div>
                            <div class="text-xs text-slate-500">Uploaded ${doc.uploaded_at} â€¢ ${sizeKb} KB</div>
                        </div>
                        <div class="flex items-center gap-3 text-xs">
                            <a class="text-emerald-700 hover:underline" href="/api/documents/${doc.id}">Download</a>
                            <button class="text-red-600 hover:underline" onclick="Handlers.deleteDocument('${doc.id}')">Delete</button>
                        </div>
                    </div>
                `;
            }).join("");
        },

        async deleteDocument(docId) {
            await ApiService.del(`/api/documents/${docId}`);
            UI.notify("Document deleted", "success");
            await Handlers.refreshDocuments();
        }
    };

    Handlers.refreshDocuments();
</script>
{% endblock %}
